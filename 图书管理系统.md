# 图书管理系统开发文档

作者：郭俊贤

实现者：林田川

代码风格：[Google 开源项目风格指南](https://zh-google-styleguide.readthedocs.io/en/latest/)

## 指令列表

```bash
# 基础指令
quit
exit

# 账户系统指令
su [User-ID] ([Password])?
logout
register [User-ID] [Password] [User-Name]
passwd [User-ID] ([Old-Password])? [New-Password]
useradd [User-ID] [Password] [Priority] [User-Name]
delete [User-ID]

# 图书系统指令
show (-ISBN=[ISBN] | -name="[Book-Name]" | -author="[Author]" | -keyword="[Keyword]")?
buy [ISBN] [Quantity]
select [ISBN]
modify (-ISBN=[ISBN] | -name="[Book-Name]" | -author="[Author]" | -keyword="[Keyword]" | -price=[Price])+
import [Quantity] [Total-Cost]

# 日志系统指令
report myself
show finance ([Time])?
report finance
report employee
log
```

- 在用户输入一条指令后，如果合法则执行对应操作，如果有则输出操作结果；如果指令非法或操作失败则输出 `Invalid\n`
  - 仅有空白符的指令合法且无输出内容
  - 除非有特殊说明，如果输入指令对应的输出内容非空，则结尾有 `\n` 字符；输出内容为空则不输出任何字符
- `quit` 和 `exit` 指令功能为正常退出系统


## 数据文件

- `user.dat` 按 User-ID 字典序存 user
- `books.dat` 储存的书本信息
- `book_ISBN.dat` 按 ISBN 升序存书本在 `books.dat` 中的位置
- `book_name.dat` 按 name 升序存书本的在 `books.dat` 中的位置
- `book_keyword.dat` 按 Keyword 升序存书本的在 `books.dat` 中的位置
- `book_author.dat` 按 Author 升序存书本的在 `books.dat` 中的位置
- `log.dat` 自由

## 代码文件

### main.cpp

基本上是个空壳子。

```c++
#include "bookstore.h"
int main(){
  Bookstore bookstore;
  bookstore.Run();
}
```

### bookstore.h / bookstore.cpp

书店类。存了 `CommandParser`、`UserManager`、`BookManager` 和 `Logger` 类的指针。它们各自也存了 `Bookstore` 的指针，这样它们就可以通过 `Bookstore` 来相互调用。

例如，`Logger` 类中的 `ShowFinance` 等操作需要调用 `UserManager` 来鉴权，同时 `UserManager` 类也需要调用 `Logger` 来记录用户的操作。这几个类之间有复杂的相互调用关系，所以都通过 `Bookstore` 来调用会更清楚一点。

bookstore.h 大概长这样：

```c++
#include "book_manager.h"
#include "command_parser.h"
#include "logger.h"
#include "user_manager.h"

class Bookstore {
  Logger *logger;
  UserManager *user_manager;
  BookManager *book_manager;
  CommandParser *command_parser;

 public:
  Bookstore();  // 把 Logger, UserManager, BookManager, CommandParser 都 new 出来
  ~Bookstore();  // 别忘了 delete
  void Run();  // 就是调用 command_parser 的 Run
};
```

### char.h

`Char<size>` 是对 `char[size + 1]` 的包装，用来存一个定长的字符串。重载了比较运算符和流提取、流插入运算符，用起来更方便。

```c++
template<const int size>
class Char {
  char content[size + 1];

 public:
  // 默认为空字符串
  Char();
  Char(const std::string &s);
  Char(const char *cstr);
  operator std::string() const;
  std::string str() const;

  Char &operator=(const Char &that);
  bool empty() const;
  friend bool operator<(const Char<size> &a, const Char<size> &b);
  friend bool operator==(const Char<size> &a, const Char<size> &b);
  friend bool operator>(const Char<size> &a, const Char<size> &b);
  friend bool operator<=(const Char<size> &a, const Char<size> &b);
  friend bool operator>=(const Char<size> &a, const Char<size> &b);
  friend bool operator!=(const Char<size> &a, const Char<size> &b);
  friend std::istream &operator>>(std::istream &is, Char<size> &s);
  friend std::ostream &operator<<(std::ostream &os, const Char<size> &s);
};
```

### command_parser.h / command_parser.cpp

执行指令

```c++
class CommandParser{
 public:
  void Run();  // 运行整个程序，循环读入指令并处理，直到遇到 quit/exit

 private:
  // 根据指令的第一个单词查找对应的函数，供 run 函数使用
  std::unordered_map<std::string, void (CommandParser::*)(const std::vector<std::string> &)> map_function;

  void ParseSu(const std::vector<std::string> &args);  // 解析 su [User-ID] ([Password])?
  void ParseLogout(const std::vector<std::string> &args);  // 解析 logout
  void ParseRegister(const std::vector<std::string> &args);  // 解析 register [User-ID] [Password] [User-Name]
  void ParsePasswd(const std::vector<std::string> &args);  // 解析 passwd [User-ID] ([Old-Password])? [New-Password]
  void ParseUseradd(const std::vector<std::string> &args);  // 解析 useradd [User-ID] [Password] [Priority] [User-Name]
  void ParseDelete(const std::vector<std::string> &args);  // 解析 delete [User-ID]

  void ParseShow(const std::vector<std::string> &args);  // 解析 show，调用 showBook 或 showFinance

  void ParseShowBook(const std::vector<std::string> &args);  // 解析 show (-ISBN=[ISBN] | -name="[Book-Name]" | -author="[Author]" | -keyword="[Keyword]")?
  void ParseBuy(const std::vector<std::string> &args);  // 解析 buy [ISBN] [Quantity]
  void ParseSelect(const std::vector<std::string> &args);  // 解析 select [ISBN]
  void ParseModify(const std::vector<std::string> &args);  // 解析 modify (-ISBN=[ISBN] | -name="[Book-Name]" | -author="[Author]" | -keyword="[Keyword]" | -price=[Price])+
  void ParseImport(const std::vector<std::string> &args);  // 解析 import [Quantity] [Total-Cost]

  void ParseReport(const std::vector<std::string> &args);  // 解析 report myself 或 report finance 或 report employee
  void ParseShowFinance(const std::vector<std::string> &args);  // 解析 show finance ([Time])?
  void ParseLog(const std::vector<std::string> &args);  // 解析 log
};
```

### user_manager.h / user_manager.cpp

实现账户管理+账户文件存储

```c++
class UserManager {
 public:
  void Login(const Char<30> &user_id, const Char<30> &password = "");  // 登录用户
  void Logout();  // 退出登录
  void ChangePassword(const Char<30> &user_id, const Char<30> &new_password);  // 修改密码
  void ChangePassword(const Char<30> &user_id, const Char<30> &old_password, const Char<30> &new_password);  // 修改密码
  void CreateUser(const Char<30> &user_id, const Char<30> &password,
                  const int priority, const Char<30> &user_name);  // 创建用户
  void Register(const Char<30> &user_id, const Char<30> &password, const Char<30> &user_name);  // 注册账户
  void Remove(const Char<30> &user_id);  // 删除账户
  void CheckPermission(int priority) const;  // 检查当前用户的权限是否 >= priority，如果不是抛出异常
  void SelectBook(std::streamoff book_offset);  // 让当前用户选这本书。调用此函数前应保证已经鉴权
  std::streamoff GetSelectedBook() const;  // 获取当前用户选择的书。0 表示没选。
 private:
  std::vector<std::pair<User, std::streamoff>> user_stack;  // 用户栈，储存登录的用户和他所选的图书的 offset
  UnrolledLinkedList<Char<30>, User> user_data;
};
```

### bookstore.h / bookstore.cpp

实现图书信息处理

```cpp
class Book {
 public:
  Char<20> ISBN;
  Char<60> name, author;
  Char<60> keyword;
  int quantity = 0;
  double price = 0.0;
};
```

```cpp
class BookManager {
 public:
  enum ArgType { ISBN, NAME, AUTHOR, KEYWORD, PRICE };  // 参数类型
  struct Argument {
    ArgType type;
    const std::string *value;
    int price;
    Argument(ArgType type, const std::string &value) : type(type), value(&value), price() {}
    Argument(ArgType type, int price) : type(type), price(price), value(nullptr) {}
  };
  void ShowAllBooks();  // 输出所有图书
  void ShowBook(Argument arg);  // 检索图书
  void BuyBook(const std::string &ISBN, int quantity);  // 购买图书
  void SelectBook(const std::string &ISBN);  // 以当前账户选中指定图书
  void ModifyBook(std::vector<Argument> &args);  // 更新选中图书的信息
  void ImportBook(int quantity, double total_cost);  // 指定交易总额购入指定数量的选中图书
};
```

### logger.h

输出日志

```cpp
class Logger {
 public:
  Logger(UserManager& user_manager_);
  void ReportMyself();  // 返回员工自己的操作记录，指令
  void ShowFinance(int time = -1);  // 输出财务记录
  void ReportFinance();  // 生成财务记录报告 
  void ReportWork();  // 生成全体员工工作情况报告
  void ReportEmployee();  // 生成员工工作情况表，记录其操作
  void Log();  // 生成日志，包括谁干了什么，以及财务上每一笔交易
};
```

### unrolled_linked_list.h

文件读写+块状链表维护

```c++
class UnrolledLinkedList{
  MemoryPool<Block> blocklist;
  struct Block{}  // 存数组
 public:
  void Split();  // block 过大时切分
  void Merge();  // block 过小时合并
  void Add();  // 加入元素
  void Erase();  // 删除元素
}
```

### memory_pool.h

维护链表中的空余空间

```c++
template <typename node_type>
class MemoryPool{  // 维护文件中空余空间
  fstream file;
  char* file_name;
 public:
  void AddBlank();  // 向 file 中的空余空间链表加元素，参量待定
  void DeleteBlank();  // 向 file 中的空余空间链表删元素，参量待定
}
```

### exceptions.h

异常处理

#### 基础异常类

作为其他异常类的基类

```cpp
class BasicException : public std::exception {
  const char *message;
  BasicException(const char *message_);
  const char *what() { return message; }
};
```

#### 指令解析异常

```cpp
// 指令太长（超出一行 1024 字节的限制）
class CommandTooLong : public BasicException {};
// 格式错误
class SyntaxError : public BasicException {};
```

注：唯一一个会在 `CommandParser` 外面抛出 `SyntaxError` 异常的是 `BookManager::ModifyBook` 中检查 keyword 的部分。

#### 用户管理异常

```cpp
// 密码错误
class IncorrectPassword : public BasicException {};
// 没有已登录用户
class NoLoggedInUser : public BasicException {};
// 用户已存在
class DuplicateUserID : public BasicException {};
// 用户不存在
class UserNotExist : public BasicException {};
// 权限错误
class PermissionError : public BasicException {};
// 删除已登录的用户
class DeleteMyself : public BasicException {};
```

#### 图书管理异常

```cpp
// 没有匹配的图书
class NoBookMatched : public BasicException {};
// 未选择图书
class NoBookSelected : public BasicException {};
// 库存不足
class StockInsufficient : public BasicException {};
// ISBN 已存在
class DuplicateISBN : public BasicException {};
```

#### 日志异常

```cpp
// 超过历史交易总笔数
class EntryNumExceeded : public BasicException {};
```
